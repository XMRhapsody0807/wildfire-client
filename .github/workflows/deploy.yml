name: Deploy Wildfire Client

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Upload to Server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "."
        target: "/opt/aiim/wildfire-client/"
        rm: true

    - name: Deploy and Restart
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          cd /opt/aiim/wildfire-client
          
          # 安装依赖
          npm install --production
          
          # 用pm2管理进程
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi
          
          # 设置环境变量
          export BACKEND_URL=http://localhost:8080
          export PORT=3001
          
          # 重启服务
          pm2 delete wildfire-client 2>/dev/null || true
          pm2 start index.js --name wildfire-client --env production
          pm2 save
          
          sleep 3
          curl -s http://localhost:3001/api/status/0 || echo "Service starting..."
